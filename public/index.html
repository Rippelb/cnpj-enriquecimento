<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Inteligência e Prospecção de Dados</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a2e;
            min-height: 100vh;
            padding: 30px 20px;
        }
        .container { max-width: 1000px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; }
        h1 { color: #00d4ff; font-size: 28px; font-weight: 600; margin-bottom: 8px; }
        .subtitle { color: #888; font-size: 14px; }

        /* Form card */
        .card {
            background: #16213e;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            border: 1px solid #0f3460;
        }
        .form-group { margin-bottom: 20px; }
        label {
            display: block; margin-bottom: 8px; font-weight: 500;
            color: #00d4ff; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;
        }
        input {
            width: 100%; padding: 14px 16px; border: 2px solid #0f3460;
            border-radius: 8px; font-size: 16px; background: #1a1a2e; color: #fff; transition: all 0.2s;
        }
        input::placeholder { color: #555; }
        input:focus { outline: none; border-color: #00d4ff; box-shadow: 0 0 0 3px rgba(0,212,255,0.1); }
        .btn {
            width: 100%; padding: 16px; border: none; border-radius: 8px;
            font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s;
            text-transform: uppercase; letter-spacing: 1px;
        }
        .btn-primary { background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%); color: #1a1a2e; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 25px rgba(0,212,255,0.3); }
        .btn-primary:disabled { background: #333; color: #666; cursor: not-allowed; transform: none; box-shadow: none; }

        .loading { text-align: center; padding: 50px; }
        .loading-spinner {
            width: 50px; height: 50px; border: 3px solid #0f3460; border-top-color: #00d4ff;
            border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 25px;
        }
        .loading p { font-size: 16px; color: #00d4ff; margin-bottom: 8px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .error {
            background: rgba(220,53,69,0.1); border: 1px solid #dc3545; color: #ff6b6b;
            padding: 15px 20px; border-radius: 8px; margin-top: 20px; display: flex; align-items: center; gap: 10px;
        }
        .error::before { content: "\26A0"; font-size: 18px; }
        .status-text { font-size: 13px; color: #666; }
        .result-section { display: none; }
        .result-section.active { display: block; }

        /* ========== DOCUMENT STYLES ========== */
        .doc {
            background: #fff;
            border-radius: 8px;
            padding: 50px 45px;
            color: #222;
            font-family: Calibri, 'Segoe UI', Arial, sans-serif;
            font-size: 11pt;
            line-height: 1.5;
            box-shadow: 0 4px 30px rgba(0,0,0,0.4);
        }
        .doc-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #003366;
        }
        .doc-header h2 {
            font-size: 12pt;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 3px;
            margin-bottom: 8px;
            font-weight: 400;
        }
        .doc-header h1 {
            font-size: 22pt;
            color: #003366;
            font-weight: 700;
            margin-bottom: 0;
        }
        .doc-section {
            margin-bottom: 24px;
        }
        .doc-section-title {
            font-size: 13pt;
            font-weight: 700;
            color: #003366;
            margin-bottom: 12px;
            padding-bottom: 6px;
            border-bottom: 1px solid #ddd;
        }
        .doc-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 8px;
        }
        .doc-table td {
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
            vertical-align: top;
        }
        .doc-table td:first-child {
            width: 200px;
            font-weight: 600;
            color: #555;
            font-size: 10pt;
        }
        .doc-table td:last-child {
            color: #222;
        }
        .doc-table tr:last-child td {
            border-bottom: none;
        }
        .doc-table a {
            color: #0066cc;
            text-decoration: none;
        }
        .doc-table a:hover {
            text-decoration: underline;
        }
        .doc-bold {
            font-weight: 700;
            color: #003366;
        }
        .doc-text {
            font-size: 11pt;
            line-height: 1.7;
            color: #333;
            margin-bottom: 8px;
        }
        .doc-checklist {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .doc-checklist li {
            padding: 5px 0;
            font-size: 11pt;
            color: #333;
        }
        .doc-checklist li.checked {
            color: #006600;
            font-weight: 600;
        }
        .doc-insights {
            list-style: disc;
            padding-left: 24px;
            margin: 0;
        }
        .doc-insights li {
            padding: 4px 0;
            font-size: 11pt;
            color: #333;
        }
        .doc-next-steps {
            list-style: none;
            padding: 0;
        }
        .doc-next-steps li {
            padding: 6px 0;
            font-size: 11pt;
            color: #555;
        }
        .doc-footer {
            margin-top: 30px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
            font-size: 9pt;
            color: #999;
            text-align: center;
        }

        /* Copy/action buttons below the doc */
        .doc-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .doc-actions .btn-action {
            flex: 1;
            min-width: 200px;
            padding: 14px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn-action:hover { transform: translateY(-2px); }
        .btn-action.copied {
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%) !important;
            color: white !important;
        }
        .btn-crm {
            background: linear-gradient(135deg, #ffd700 0%, #ffaa00 100%);
            color: #1a1a2e;
        }
        .btn-crm:hover { box-shadow: 0 5px 20px rgba(255,215,0,0.3); }
        .btn-seller {
            background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
            color: #1a1a2e;
        }
        .btn-seller:hover { box-shadow: 0 5px 20px rgba(0,212,255,0.3); }
        .btn-full {
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
            color: white;
        }
        .btn-full:hover { box-shadow: 0 5px 20px rgba(40,167,69,0.3); }

        /* Fallback raw text */
        .result-box {
            background: #0d1b2a; border: 1px solid #1b3a4b; border-radius: 8px;
            padding: 25px; font-family: Consolas, Monaco, monospace; font-size: 13px;
            line-height: 1.7; max-height: 700px; overflow-y: auto; color: #e0e0e0;
            white-space: pre-wrap; word-wrap: break-word;
        }

        @media print {
            body { background: white; padding: 0; }
            .card, .header, .doc-actions, .result-box { display: none !important; }
            .result-section { display: block !important; }
            .doc { box-shadow: none; padding: 20px 0; }
        }
        @media (max-width: 640px) {
            .doc { padding: 25px 20px; }
            .doc-table td:first-child { width: 130px; }
            .doc-actions { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Sistema de Inteligência e Prospecção</h1>
            <p class="subtitle">Análise completa de dados empresariais com IA</p>
        </div>

        <div class="card">
            <form id="form">
                <div class="form-group">
                    <label>CNPJ da Empresa</label>
                    <input type="text" id="cnpj" placeholder="00.000.000/0001-00" required>
                </div>
                <div class="form-group">
                    <label>Nome da Empresa (opcional)</label>
                    <input type="text" id="nome" placeholder="Ajuda a encontrar informações mais precisas">
                </div>
                <button type="submit" class="btn btn-primary" id="submitBtn">Gerar Relatório</button>
            </form>
            <div class="loading" id="loading" style="display: none;">
                <div class="loading-spinner"></div>
                <p>Gerando relatório de inteligência...</p>
                <p class="status-text" id="statusText">Iniciando análise...</p>
            </div>
            <div class="error" id="error" style="display: none;"></div>
        </div>

        <div class="result-section" id="resultSection">
            <div id="resultsContainer" style="display: none;"></div>
            <div class="result-box" id="fallbackResultBox" style="display: none;"></div>
        </div>
    </div>

    <script>
        let rawText = '';
        let plainTextForCopy = '';
        let crmResumoText = '';
        let sellerReportText = '';
        let parsedData = null;

        // Mascara CNPJ
        document.getElementById('cnpj').addEventListener('input', (e) => {
            let v = e.target.value.replace(/\D/g, '').slice(0, 14);
            if (v.length > 12) v = v.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})$/, '$1.$2.$3/$4-$5');
            else if (v.length > 8) v = v.replace(/^(\d{2})(\d{3})(\d{3})(\d+)$/, '$1.$2.$3/$4');
            else if (v.length > 5) v = v.replace(/^(\d{2})(\d{3})(\d+)$/, '$1.$2.$3');
            else if (v.length > 2) v = v.replace(/^(\d{2})(\d+)$/, '$1.$2');
            e.target.value = v;
        });

        function extractJSON(raw) {
            if (!raw || typeof raw !== 'string') return null;
            const fenceMatch = raw.match(/```json\s*([\s\S]*?)```/);
            if (fenceMatch) { try { return JSON.parse(fenceMatch[1].trim()); } catch (e) {} }
            try { return JSON.parse(raw.trim()); } catch (e) {}
            const firstBrace = raw.indexOf('{');
            const lastBrace = raw.lastIndexOf('}');
            if (firstBrace !== -1 && lastBrace > firstBrace) {
                try { return JSON.parse(raw.substring(firstBrace, lastBrace + 1)); } catch (e) {}
            }
            return null;
        }

        function esc(str) {
            if (str === null || str === undefined) return '';
            return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
        }
        function v(val) {
            if (val === null || val === undefined || val === '' || val === 'N/A' || val === 'Não disponível' || val === 'Não encontrado' || val === 'PESQUISAR' || val === 'CALCULAR') return 'N/A';
            return String(val);
        }
        function getNestedValue(obj, path) {
            if (!obj) return undefined;
            const parts = path.split('.');
            let current = obj;
            for (const part of parts) { if (current === null || current === undefined) return undefined; current = current[part]; }
            return current;
        }
        function findValue(data, keys) {
            for (const key of keys) { const val = getNestedValue(data, key); if (val !== undefined && val !== null && val !== '') return val; }
            return undefined;
        }
        function tableRow(label, value, bold) {
            const cls = bold ? ' class="doc-bold"' : '';
            return '<tr><td>' + esc(label) + '</td><td' + cls + '>' + value + '</td></tr>';
        }
        function linkCell(url, text) {
            if (!url || url === 'N/A' || url === 'Não encontrado' || url === 'PESQUISAR') return 'N/A';
            return '<a href="' + esc(url) + '" target="_blank" rel="noopener">' + esc(text || url) + '</a>';
        }
        function calcYears(dateStr) {
            if (!dateStr) return '';
            const parts = dateStr.split(/[-\/]/);
            let year;
            if (parts[0].length === 4) year = parseInt(parts[0]);
            else if (parts[2] && parts[2].length === 4) year = parseInt(parts[2]);
            else return '';
            const years = new Date().getFullYear() - year;
            return years > 0 ? ' (+' + years + ' anos no mercado)' : '';
        }

        // ========== RENDER FICHA COMERCIAL ==========
        function renderResults(data) {
            const nomeFantasia = v(findValue(data, ['nome_fantasia','nomeFantasia']));
            const razaoSocial = v(findValue(data, ['razao_social','razaoSocial']));
            const titulo = nomeFantasia !== 'N/A' ? nomeFantasia : razaoSocial;
            const dataFundacao = v(findValue(data, ['data_fundacao','dataFundacao','data_abertura']));

            let html = '<div class="doc">';

            // === HEADER ===
            html += '<div class="doc-header">';
            html += '<h2>Ficha Comercial</h2>';
            html += '<h1>' + esc(titulo) + '</h1>';
            html += '</div>';

            // === 1. DADOS DA EMPRESA ===
            const cnaeRaw = findValue(data, ['cnae_principal','cnaePrincipal','cnae']);
            let cnaeStr = 'N/A';
            if (typeof cnaeRaw === 'object' && cnaeRaw) cnaeStr = [cnaeRaw.codigo, cnaeRaw.descricao].filter(Boolean).join(' - ') || 'N/A';
            else if (cnaeRaw) cnaeStr = String(cnaeRaw);

            html += '<div class="doc-section">';
            html += '<div class="doc-section-title">&#x1F4CB; Dados da Empresa</div>';
            html += '<table class="doc-table">';
            html += tableRow('Razão Social', esc(razaoSocial));
            html += tableRow('CNPJ', esc(v(findValue(data, ['cnpj','CNPJ']))));
            html += tableRow('Fundação', esc(dataFundacao + calcYears(dataFundacao)));
            html += tableRow('Porte', esc(v(findValue(data, ['classificacao_porte_bndes','classificacao_bndes']))), true);
            html += tableRow('Funcionários', esc(v(findValue(data, ['estimativa_final_funcionarios','funcionarios']))) + ' colaboradores');
            html += tableRow('Faturamento', esc(v(findValue(data, ['estimativa_final_faturamento','faturamento_estimado']))), true);
            html += tableRow('Segmento', esc(v(findValue(data, ['nicho_de_mercado','nicho','nicho_mercado']))));
            html += '</table></div>';

            // === 2. CONTATO DIRETO ===
            const tel = findValue(data, ['telefone','telefones']);
            const telStr = Array.isArray(tel) ? tel.join(', ') : v(tel);
            const email = findValue(data, ['email','e-mail']);
            const emailStr = Array.isArray(email) ? email.join(', ') : v(email);
            const site = findValue(data, ['site_oficial','site','website']);
            const igData = findValue(data, ['instagram']);
            let igStr = 'N/A';
            if (typeof igData === 'object' && igData) igStr = igData.perfil || igData.url || 'N/A';
            else if (igData) igStr = String(igData);

            const end = findValue(data, ['endereco','endereço']);
            let endStr = 'N/A';
            if (typeof end === 'object' && end) endStr = [end.logradouro, end.numero, end.bairro, (end.cidade||end.municipio), end.uf, end.cep].filter(Boolean).join(', ') || 'N/A';
            else if (end) endStr = String(end);

            const gMaps = findValue(data, ['google_maps']);
            const mapsLink = (typeof gMaps === 'object' && gMaps) ? (gMaps.link || gMaps.url || '') : '';

            html += '<div class="doc-section">';
            html += '<div class="doc-section-title">&#x1F4DE; Contato Direto</div>';
            html += '<table class="doc-table">';
            html += tableRow('Telefone', '<strong>' + esc(telStr) + '</strong>');
            html += tableRow('E-mail', '<strong>' + esc(emailStr) + '</strong>');
            html += tableRow('Site', site ? linkCell(site, site) : 'N/A');
            html += tableRow('Instagram', esc(igStr));
            html += tableRow('Localização', mapsLink ? linkCell(mapsLink, endStr) : esc(endStr));
            html += '</table></div>';

            // === 3. INDICADORES DE QUALIFICAÇÃO ===
            const nad = findValue(data, ['nivel_atividade_digital']);
            let scoreStr = 'N/A';
            if (typeof nad === 'object' && nad) scoreStr = (nad.score || '?') + ' - ' + (nad.classificacao || '');
            else if (nad) scoreStr = String(nad);

            const glassdoor = findValue(data, ['glassdoor']);
            let glStr = 'Não avaliado';
            if (typeof glassdoor === 'object' && glassdoor) {
                const nota = glassdoor.classificacao || glassdoor.nota || '';
                const aval = glassdoor.numero_avaliacoes || '';
                if (nota) glStr = nota + (aval ? ' (' + aval + ' avaliações)' : '');
            }

            const li = findValue(data, ['linkedin']);
            let liStr = 'N/A';
            if (typeof li === 'object' && li) {
                const func = li.funcionarios_registrados || '?';
                const seg = li.seguidores || '?';
                liStr = func + ' funcionários / ' + seg + ' seguidores';
            }

            html += '<div class="doc-section">';
            html += '<div class="doc-section-title">&#x1F3AF; Indicadores de Qualificação</div>';
            html += '<table class="doc-table">';
            html += tableRow('Atividade Digital', '<strong>' + esc(scoreStr) + '</strong>');
            html += tableRow('Glassdoor', esc(glStr));
            html += tableRow('LinkedIn', esc(liStr));
            html += '</table></div>';

            // === 4. ANÁLISE DE FIT COM ICP ===
            const icpData = findValue(data, ['analise_icp_mave','analise_icp']);
            const nicho = v(findValue(data, ['nicho_de_mercado','nicho'])).toLowerCase();
            const cnaeDesc = (typeof cnaeRaw === 'object' && cnaeRaw) ? (cnaeRaw.descricao || '').toLowerCase() : String(cnaeRaw || '').toLowerCase();
            const perfilStr = (typeof icpData === 'object' && icpData) ? String(icpData.perfil || '').toUpperCase() : '';
            const fitStr = (typeof icpData === 'object' && icpData) ? String(icpData.nivel_fit || icpData.fit || '') : '';
            const justificativa = (typeof icpData === 'object' && icpData) ? (icpData.justificativa || '') : '';
            const temProdutos = (typeof gMaps === 'object' && gMaps) ? String(gMaps.tem_produtos_expostos || '').toLowerCase() : '';

            const isRevenda = perfilStr.includes('A') || cnaeDesc.includes('comércio') || cnaeDesc.includes('comercio') || cnaeDesc.includes('varejo');
            const isTransp = perfilStr.includes('B') || nicho.includes('transport') || cnaeDesc.includes('transport');
            const temProdExpostos = temProdutos.includes('sim') || isRevenda;
            const clientesMave = nicho.includes('transport') || nicho.includes('carga') || nicho.includes('construção') || nicho.includes('construcao') || nicho.includes('indust');
            const usaCintas = isTransp;

            function checkbox(checked, text) {
                return '<li class="' + (checked ? 'checked' : '') + '">' + (checked ? '&#9745;' : '&#9744;') + ' ' + esc(text) + '</li>';
            }

            html += '<div class="doc-section">';
            html += '<div class="doc-section-title">&#x2705; Análise de Fit com ICP</div>';
            html += '<ul class="doc-checklist">';
            html += checkbox(isRevenda, 'É REVENDA (Ferragens / Mat. Construção / Acess. Caminhão / Loja Agrícola)');
            html += checkbox(temProdExpostos, 'Possui produtos expostos e equipe de vendas');
            html += checkbox(clientesMave, 'Clientes usam material MAVE (Transportadoras / Indústrias / Construção)');
            html += checkbox(isTransp, 'É TRANSPORTADORA com +10 caminhões');
            html += checkbox(usaCintas, 'Usa cintas na amarração (Grade baixa/alta / Sider / Florestal)');
            html += '</ul>';
            if (fitStr || justificativa) {
                html += '<p class="doc-text" style="margin-top:10px"><strong>Nível de Fit: ' + esc(fitStr) + '</strong>';
                if (justificativa) html += ' — ' + esc(justificativa);
                html += '</p>';
            }
            html += '</div>';

            // === 5. INSIGHTS PARA ABORDAGEM ===
            const insights = findValue(data, ['insights_abordagem']);
            if (Array.isArray(insights) && insights.length > 0) {
                html += '<div class="doc-section">';
                html += '<div class="doc-section-title">&#x1F4A1; Insights para Abordagem</div>';
                html += '<ul class="doc-insights">';
                for (const insight of insights) html += '<li>' + esc(String(insight)) + '</li>';
                html += '</ul></div>';
            }

            // === 6. RESUMO PARA CRM ===
            const resumoCrm = findValue(data, ['resumo_para_crm','resumo_crm','resumo']);
            if (resumoCrm && v(resumoCrm) !== 'N/A') {
                html += '<div class="doc-section">';
                html += '<div class="doc-section-title">&#x1F4DD; Resumo para o CRM</div>';
                html += '<p class="doc-text">' + esc(String(resumoCrm)) + '</p>';
                html += '</div>';
            }

            // === 7. RELATÓRIO PARA O VENDEDOR ===
            const relVendedor = findValue(data, ['relatorio_vendedor']);
            if (relVendedor && v(relVendedor) !== 'N/A') {
                html += '<div class="doc-section">';
                html += '<div class="doc-section-title">&#x1F4BC; Relatório para o Vendedor</div>';
                html += '<p class="doc-text">' + esc(String(relVendedor)) + '</p>';
                html += '</div>';
            }

            // === 8. PRÓXIMOS PASSOS ===
            html += '<div class="doc-section">';
            html += '<div class="doc-section-title">&#x1F4DD; Próximos Passos</div>';
            html += '<ul class="doc-next-steps">';
            html += '<li>&#9744; Primeiro contato via: ______________________</li>';
            html += '<li>&#9744; Data do contato: ____/____/____</li>';
            html += '<li>&#9744; Decisor identificado: ______________________</li>';
            html += '<li>&#9744; Interesse demonstrado: ______________________</li>';
            html += '</ul></div>';

            // === FOOTER ===
            const dataPesquisa = v(findValue(data, ['data_pesquisa','data']));
            const fontes = findValue(data, ['fontes_consultadas','fontes']);
            const fontesStr = Array.isArray(fontes) ? fontes.join(', ') : v(fontes);
            html += '<div class="doc-footer">';
            html += 'Relatório gerado em: ' + esc(dataPesquisa) + ' | Fontes: ' + esc(fontesStr);
            html += '</div>';

            html += '</div>'; // close .doc

            // === ACTION BUTTONS ===
            html += '<div class="doc-actions">';
            html += '<button class="btn-action btn-crm" id="btnCrmCopy" onclick="copiarResumoCrm()">&#x1F4CB; Copiar Resumo CRM</button>';
            html += '<button class="btn-action btn-seller" id="btnSellerCopy" onclick="copiarRelatorioVendedor()">&#x1F4BC; Copiar Rel. Vendedor</button>';
            html += '<button class="btn-action btn-full" id="copyBtn" onclick="copiarResultado()">&#x1F4CB; Copiar Tudo (PipeRun)</button>';
            html += '</div>';

            return html;
        }

        // ========== GENERATE PLAIN TEXT ==========
        function generatePlainText(data) {
            let lines = [];
            const nomeFantasia = v(findValue(data, ['nome_fantasia','nomeFantasia']));
            const razaoSocial = v(findValue(data, ['razao_social','razaoSocial']));
            const titulo = nomeFantasia !== 'N/A' ? nomeFantasia : razaoSocial;

            lines.push('FICHA COMERCIAL — ' + titulo);
            lines.push('');

            const resumoCrm = findValue(data, ['resumo_para_crm','resumo_crm','resumo']);
            if (resumoCrm && v(resumoCrm) !== 'N/A') {
                lines.push('=== RESUMO PARA O CRM ===');
                lines.push(String(resumoCrm));
                lines.push('');
            }

            lines.push('=== DADOS DA EMPRESA ===');
            lines.push('Razão Social: ' + razaoSocial);
            lines.push('CNPJ: ' + v(findValue(data, ['cnpj'])));
            const df = v(findValue(data, ['data_fundacao','dataFundacao']));
            lines.push('Fundação: ' + df);
            lines.push('Porte: ' + v(findValue(data, ['classificacao_porte_bndes'])));
            lines.push('Funcionários: ' + v(findValue(data, ['estimativa_final_funcionarios'])));
            lines.push('Faturamento: ' + v(findValue(data, ['estimativa_final_faturamento'])));
            lines.push('Segmento: ' + v(findValue(data, ['nicho_de_mercado'])));

            lines.push('');
            lines.push('=== CONTATO ===');
            const tel = findValue(data, ['telefone']);
            lines.push('Telefone: ' + (Array.isArray(tel) ? tel.join(', ') : v(tel)));
            const email = findValue(data, ['email']);
            lines.push('E-mail: ' + (Array.isArray(email) ? email.join(', ') : v(email)));
            lines.push('Site: ' + v(findValue(data, ['site_oficial'])));

            const end = findValue(data, ['endereco']);
            let endStr = 'N/A';
            if (typeof end === 'object' && end) endStr = [end.logradouro, end.numero, end.bairro, (end.cidade||end.municipio), end.uf, end.cep].filter(Boolean).join(', ') || 'N/A';
            else if (end) endStr = String(end);
            lines.push('Endereço: ' + endStr);

            lines.push('');
            lines.push('=== INDICADORES ===');
            const nad = findValue(data, ['nivel_atividade_digital']);
            if (typeof nad === 'object' && nad) lines.push('Atividade Digital: ' + (nad.score||'N/A') + ' - ' + (nad.classificacao||''));
            else lines.push('Atividade Digital: ' + v(nad));

            const glassdoor = findValue(data, ['glassdoor']);
            if (typeof glassdoor === 'object' && glassdoor) {
                const nota = glassdoor.classificacao || glassdoor.nota || '';
                const aval = glassdoor.numero_avaliacoes || '';
                lines.push('Glassdoor: ' + (nota || 'Não avaliado') + (aval ? ' (' + aval + ' avaliações)' : ''));
            } else lines.push('Glassdoor: Não avaliado');

            const li = findValue(data, ['linkedin']);
            if (typeof li === 'object' && li) lines.push('LinkedIn: ' + (li.funcionarios_registrados||'?') + ' func. / ' + (li.seguidores||'?') + ' seg.');

            const icpData = findValue(data, ['analise_icp_mave','analise_icp']);
            if (typeof icpData === 'object' && icpData) {
                lines.push('');
                lines.push('=== ANÁLISE ICP ===');
                lines.push('Perfil: ' + v(icpData.perfil));
                lines.push('Fit: ' + v(icpData.nivel_fit || icpData.fit));
                lines.push('Justificativa: ' + v(icpData.justificativa));
            }

            const insights = findValue(data, ['insights_abordagem']);
            if (Array.isArray(insights) && insights.length > 0) {
                lines.push('');
                lines.push('=== INSIGHTS ===');
                for (const i of insights) lines.push('• ' + String(i));
            }

            const relVendedor = findValue(data, ['relatorio_vendedor']);
            if (relVendedor && v(relVendedor) !== 'N/A') {
                lines.push('');
                lines.push('=== RELATÓRIO VENDEDOR ===');
                lines.push(String(relVendedor));
            }

            return lines.join('\n');
        }

        function formatReport(text) {
            let html = text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
            html = html.replace(/(https?:\/\/[^\s\)]+)/g, '<a href="$1" target="_blank" style="color:#4da6ff">$1</a>');
            return html;
        }

        async function checkTaskStatus(taskId) {
            const response = await fetch('/api/status?id=' + taskId);
            return await response.json();
        }

        function displayResults(rawResult) {
            rawText = rawResult;
            const resultsContainer = document.getElementById('resultsContainer');
            const fallbackBox = document.getElementById('fallbackResultBox');
            parsedData = extractJSON(rawResult);
            if (parsedData && typeof parsedData === 'object') {
                resultsContainer.innerHTML = renderResults(parsedData);
                plainTextForCopy = generatePlainText(parsedData);
                crmResumoText = String(findValue(parsedData, ['resumo_para_crm','resumo_crm','resumo']) || '');
                sellerReportText = String(findValue(parsedData, ['relatorio_vendedor']) || '');
                resultsContainer.style.display = 'block';
                fallbackBox.style.display = 'none';
            } else {
                fallbackBox.innerHTML = formatReport(rawResult);
                plainTextForCopy = rawResult;
                resultsContainer.style.display = 'none';
                fallbackBox.style.display = 'block';
            }
        }

        document.getElementById('form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const cnpj = document.getElementById('cnpj').value.trim();
            const nome = document.getElementById('nome').value.trim();
            if (cnpj.replace(/\D/g, '').length !== 14) { alert('CNPJ deve ter 14 dígitos'); return; }

            const btn = document.getElementById('submitBtn');
            const loading = document.getElementById('loading');
            const statusText = document.getElementById('statusText');
            const error = document.getElementById('error');
            const resultSection = document.getElementById('resultSection');

            btn.disabled = true;
            loading.style.display = 'block';
            error.style.display = 'none';
            resultSection.classList.remove('active');
            statusText.textContent = 'Iniciando análise...';

            try {
                const createResponse = await fetch('/api/enriquecer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cnpj, nome })
                });
                const createData = await createResponse.json();
                if (!createResponse.ok) throw new Error(createData.error || 'Erro ao iniciar análise');
                const taskId = createData.taskId;

                let attempts = 0;
                const maxAttempts = 180;
                const messages = [
                    'Consultando bases oficiais...', 'Buscando dados cadastrais...',
                    'Analisando Receita Federal...', 'Verificando situação cadastral...',
                    'Coletando dados econômicos...', 'Pesquisando redes sociais...',
                    'Analisando presença digital...', 'Buscando informações de contato...',
                    'Verificando Google Maps...', 'Analisando fit com ICP...',
                    'Calculando estimativas...', 'Gerando insights de abordagem...',
                    'Compilando ficha comercial...', 'Finalizando análise...'
                ];

                while (attempts < maxAttempts) {
                    await new Promise(r => setTimeout(r, 5000));
                    attempts++;
                    const msgIndex = Math.min(Math.floor(attempts / 4), messages.length - 1);
                    statusText.textContent = messages[msgIndex] + ' (' + (attempts * 5) + 's)';
                    try {
                        const statusData = await checkTaskStatus(taskId);
                        if (statusData.status === 'completed') {
                            displayResults(statusData.resultado);
                            resultSection.classList.add('active');
                            loading.style.display = 'none';
                            btn.disabled = false;
                            resultSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            return;
                        }
                        if (statusData.status === 'failed') throw new Error(statusData.error || 'Falha na análise');
                    } catch (pollError) {
                        if (pollError.message && (pollError.message.includes('Falha') || pollError.message.includes('failed'))) throw pollError;
                    }
                }
                throw new Error('Timeout: a análise demorou demais');
            } catch (err) {
                error.textContent = err.message;
                error.style.display = 'flex';
            } finally {
                btn.disabled = false;
                loading.style.display = 'none';
            }
        });

        function copyBtn(btnId, text, label) {
            navigator.clipboard.writeText(text).then(function() {
                var b = document.getElementById(btnId);
                var orig = b.innerHTML;
                b.innerHTML = '&#x2705; Copiado!';
                b.classList.add('copied');
                setTimeout(function() { b.innerHTML = orig; b.classList.remove('copied'); }, 2000);
            });
        }
        function copiarResumoCrm() { copyBtn('btnCrmCopy', crmResumoText, ''); }
        function copiarRelatorioVendedor() { copyBtn('btnSellerCopy', sellerReportText, ''); }
        function copiarResultado() { copyBtn('copyBtn', plainTextForCopy, ''); }
    </script>
</body>
</html>
